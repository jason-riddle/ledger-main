name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  beancount-check:
    name: Beancount Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run bean-check on main.bean
        run: |
          # Install the project and its dependencies to make plugins available
          uv run bean-check ledger/main.bean

  beancount-format:
    name: Beancount Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Check bean-format on all bean files
        run: |
          # Find all .bean files and check if they are formatted
          # Using -exec to avoid subshell issues and handle special characters
          errors=0
          while IFS= read -r -d '' file; do
            echo "Checking format of $file"
            # bean-format outputs the formatted version; compare with original
            if ! uv run bean-format "$file" | diff -u "$file" - > /dev/null; then
              echo "ERROR: $file is not formatted correctly"
              echo "Run: bean-format -o $file $file"
              errors=$((errors + 1))
            fi
          done < <(find . -name "*.bean" -type f -print0)

          if [ $errors -gt 0 ]; then
            echo "Found $errors incorrectly formatted file(s)"
            exit 1
          fi
          echo "All bean files are properly formatted"

  verification-scripts:
    name: Run Verification Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run verify_depreciation.py
        run: uv run scripts/depreciation/verify_depreciation.py

      - name: Run verify_amortization.py
        run: uv run scripts/amortization/verify_amortization.py

  python-tests:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run unit tests
        run: |
          # Run each test file individually since they have inline dependencies (PEP 723)
          # Using `uv run` instead of pytest to leverage inline script metadata
          echo "Running test_depreciation.py..."
          uv run scripts/depreciation/tests/test_depreciation.py
          echo "Running test_amortization.py..."
          uv run scripts/amortization/tests/test_amortization.py

  golden-tests:
    name: Golden Tests (Statement Parsers)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run golden tests
        run: |
          # Run golden tests for SPS, Clover Leaf, and Sheer Value parsers
          uv run pytest tests/ -v

  plugin-tests:
    name: Plugin Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run plugin tests
        run: |
          # Run plugin tests
          uv run src/plugins/tests/test_find_duplicates.py -v

  python-linting:
    name: Python Linting (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run ruff check
        run: |
          # Check all Python code in the repository
          uv tool run ruff check scripts/ src/ tests/ schema/

  python-type-checking:
    name: Python Type Checking (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run mypy
        run: |
          # Run mypy on all Python code in the repository
          # Using --explicit-package-bases to handle duplicate module names in different directories
          # Excluding files with pre-existing type errors
          uv tool run mypy scripts/ src/ tests/ schema/ --ignore-missing-imports --explicit-package-bases --exclude 'scripts/check-pdf-bean.py' --exclude 'src/beanout/clover_leaf.py'

  jsonl-validation:
    name: JSONL Schema Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install jsonschema

      - name: Validate all JSONL files
        run: |
          # Find all .jsonl files and validate them against the schema
          errors=0
          jsonl_files=$(find . -name "*.jsonl" -type f)
          
          if [ -z "$jsonl_files" ]; then
            echo "No JSONL files found to validate"
            exit 0
          fi
          
          for file in $jsonl_files; do
            echo "Validating $file"
            if ! python schema/validate_jsonl.py "$file"; then
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "Found $errors file(s) with validation errors"
            exit 1
          fi
          echo "All JSONL files are valid"

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  beancount-check:
    name: Beancount Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Beancount
        run: |
          pip install --upgrade pip
          pip install beancount>=3.0.0
      
      - name: Run bean-check on main.bean
        run: bean-check ledger/main.bean

  beancount-format:
    name: Beancount Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Beancount
        run: |
          pip install --upgrade pip
          pip install beancount>=3.0.0
      
      - name: Check bean-format on all bean files
        run: |
          # Find all .bean files and check if they are formatted
          find . -name "*.bean" -type f | while read file; do
            echo "Checking format of $file"
            # bean-format outputs the formatted version; compare with original
            if ! bean-format "$file" | diff -u "$file" - > /dev/null; then
              echo "ERROR: $file is not formatted correctly"
              echo "Run: bean-format -o $file $file"
              exit 1
            fi
          done
          echo "All bean files are properly formatted"

  verification-scripts:
    name: Run Verification Scripts
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow failure as scripts may detect ledger discrepancies
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Run verify_depreciation.py
        run: uv run scripts/verify_depreciation.py
      
      - name: Run verify_amortization.py
        run: uv run scripts/verify_amortization.py

  python-tests:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Run unit tests
        run: |
          # Run each test file individually since they have inline dependencies
          echo "Running test_depreciation.py..."
          uv run scripts/tests/test_depreciation.py
          echo "Running test_amortization.py..."
          uv run scripts/tests/test_amortization.py

  python-linting:
    name: Python Linting (ruff)
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow failure until existing violations are fixed
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Run ruff check
        run: |
          uv tool run ruff check scripts/

  python-type-checking:
    name: Python Type Checking (mypy)
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow failure until existing violations are fixed
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Install mypy
        run: |
          pip install mypy
      
      - name: Run mypy
        run: |
          # Run mypy on all Python files in scripts/
          mypy scripts/ --ignore-missing-imports

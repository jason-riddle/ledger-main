name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  beancount-check:
    name: Beancount Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Beancount
        run: |
          pip install --upgrade pip
          pip install beancount>=3.0.0

      - name: Run bean-check on main.bean
        run: bean-check ledger/main.bean

  beancount-format:
    name: Beancount Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Beancount
        run: |
          pip install --upgrade pip
          pip install beancount>=3.0.0

      - name: Check bean-format on all bean files
        run: |
          # Find all .bean files and check if they are formatted
          # Using -exec to avoid subshell issues and handle special characters
          errors=0
          while IFS= read -r -d '' file; do
            echo "Checking format of $file"
            # bean-format outputs the formatted version; compare with original
            if ! bean-format "$file" | diff -u "$file" - > /dev/null; then
              echo "ERROR: $file is not formatted correctly"
              echo "Run: bean-format -o $file $file"
              errors=$((errors + 1))
            fi
          done < <(find . -name "*.bean" -type f -print0)

          if [ $errors -gt 0 ]; then
            echo "Found $errors incorrectly formatted file(s)"
            exit 1
          fi
          echo "All bean files are properly formatted"

  verification-scripts:
    name: Run Verification Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run verify_depreciation.py
        run: uv run scripts/verify_depreciation.py

      - name: Run verify_amortization.py
        run: uv run scripts/verify_amortization.py

  python-tests:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run unit tests
        run: |
          # Run each test file individually since they have inline dependencies (PEP 723)
          # Using `uv run` instead of pytest to leverage inline script metadata
          echo "Running test_depreciation.py..."
          uv run scripts/tests/test_depreciation.py
          echo "Running test_amortization.py..."
          uv run scripts/tests/test_amortization.py

  python-linting:
    name: Python Linting (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run ruff check
        run: |
          # Note: Only checking scripts/ directory as that's where Python code lives
          uv tool run ruff check scripts/

  python-type-checking:
    name: Python Type Checking (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Run mypy
        run: |
          # Run mypy on all Python files in scripts/
          # Note: Only checking scripts/ directory as that's where Python code lives
          uv tool run mypy scripts/ --ignore-missing-imports

  jsonl-validation:
    name: JSONL Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install jsonschema

      - name: Validate all JSONL files
        run: |
          # Find all .jsonl files and validate them against the schema
          errors=0
          jsonl_files=$(find . -name "*.jsonl" -type f)
          
          if [ -z "$jsonl_files" ]; then
            echo "No JSONL files found to validate"
            exit 0
          fi
          
          for file in $jsonl_files; do
            echo "Validating $file"
            if ! python schema/validate_jsonl.py "$file"; then
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "Found $errors file(s) with validation errors"
            exit 1
          fi
          echo "All JSONL files are valid"
